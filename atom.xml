<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>http://weakcc.github.io</id>
    <title>è…°ç›é†‹</title>
    <updated>2021-11-12T03:16:54.662Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="http://weakcc.github.io"/>
    <link rel="self" href="http://weakcc.github.io/atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>http://weakcc.github.io/images/avatar.png</logo>
    <icon>http://weakcc.github.io/favicon.ico</icon>
    <rights>All rights reserved 2021, è…°ç›é†‹</rights>
    <entry>
        <title type="html"><![CDATA[é€šè¿‡ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ä¿è¯æ•°æ®åº“äº‹åŠ¡çš„ä¸€è‡´æ€§]]></title>
        <id>http://weakcc.github.io/post/tong-guo-mvccduo-ban-ben-bing-fa-kong-zhi-bao-zheng-shu-ju-ku-shi-wu-de-yi-zhi-xing/</id>
        <link href="http://weakcc.github.io/post/tong-guo-mvccduo-ban-ben-bing-fa-kong-zhi-bao-zheng-shu-ju-ku-shi-wu-de-yi-zhi-xing/">
        </link>
        <updated>2021-11-12T00:18:09.000Z</updated>
        <summary type="html"><![CDATA[<p><code>MVCC</code> çš„è‹±æ–‡å…¨ç§°æ˜¯ <strong>Multiversion Concurrency Control</strong>ï¼Œä¸­æ–‡æ„æ€æ˜¯å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æŠ€æœ¯ã€‚åŸç†æ˜¯ï¼Œé€šè¿‡æ•°æ®è¡Œçš„å¤šä¸ªç‰ˆæœ¬ç®¡ç†æ¥å®ç°æ•°æ®åº“çš„å¹¶å‘æ§åˆ¶ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¿å­˜æ•°æ®çš„å†å²ç‰ˆæœ¬ã€‚å¯ä»¥é€šè¿‡æ¯”è¾ƒç‰ˆæœ¬å·å†³å®šæ•°æ®æ˜¯å¦æ˜¾ç¤ºå‡ºæ¥ã€‚è¯»å–æ•°æ®çš„æ—¶å€™ä¸éœ€è¦åŠ é”å¯ä»¥ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ•ˆæœã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p><code>MVCC</code> çš„è‹±æ–‡å…¨ç§°æ˜¯ <strong>Multiversion Concurrency Control</strong>ï¼Œä¸­æ–‡æ„æ€æ˜¯å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æŠ€æœ¯ã€‚åŸç†æ˜¯ï¼Œé€šè¿‡æ•°æ®è¡Œçš„å¤šä¸ªç‰ˆæœ¬ç®¡ç†æ¥å®ç°æ•°æ®åº“çš„å¹¶å‘æ§åˆ¶ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¿å­˜æ•°æ®çš„å†å²ç‰ˆæœ¬ã€‚å¯ä»¥é€šè¿‡æ¯”è¾ƒç‰ˆæœ¬å·å†³å®šæ•°æ®æ˜¯å¦æ˜¾ç¤ºå‡ºæ¥ã€‚è¯»å–æ•°æ®çš„æ—¶å€™ä¸éœ€è¦åŠ é”å¯ä»¥ä¿è¯äº‹åŠ¡çš„éš”ç¦»æ•ˆæœã€‚</p>
<!-- more -->
<h2 id="undo-æ—¥å¿—é“¾è¡¨">undo æ—¥å¿—é“¾è¡¨</h2>
<p>å½“ InnoDB å¼•æ“åº•å±‚å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡çš„æ—¶å€™ï¼Œä¼šåˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„äº‹åŠ¡ IDï¼Œè¯¥äº‹åŠ¡ ID å†™å…¥ undo æ—¥å¿—çš„åŒæ—¶ä¹Ÿä¼šå­˜å‚¨åˆ°æ•°æ®è¡¨è®°å½•ç°‡æ‹¥ç´¢å¼•çš„ <code>trx_id</code> éšè—åˆ—ä¸­ã€‚<br>
<img src="http://weakcc.github.io/post-images/1636676416765.png" alt="" loading="lazy"><br>
å¦ä¸€ä¸ªéšè—åˆ— <code>roll_pointer</code> æŒ‡é’ˆä¼šæŒ‡å‘è¯¥è®°å½•ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„ undo æ—¥å¿—ï¼Œå‘ç”Ÿäº‹åŠ¡å›æ»šæ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥æŒ‡é’ˆæ‰¾åˆ°è¿™æ¡è®°å½•è¦å›æ»šåˆ°çš„ç‰ˆæœ¬ã€‚<br>
è¿™æ ·ï¼Œæ¯æ¬¡è®°å½•æ›´æ–°åï¼Œä¸Šä¸€ä¸ªç‰ˆæœ¬çš„å€¼å°±ä¼šè¢«å­˜æ”¾åˆ° undo æ—¥å¿—ä¸­ï¼Œå¹¶ä¸”å°†å½“å‰æœ€æ–°è®°å½•çš„ <code>roll_pointer</code> æŒ‡é’ˆæŒ‡å‘è¯¥ undo æ—¥å¿—ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæ‰€æœ‰çš„ <code>roll_pointer</code> æŒ‡é’ˆä¸²æˆä¸€ä¸ªé“¾è¡¨ï¼Œè¯¥é“¾è¡¨è¢«ç§°ä½œç‰ˆæœ¬é“¾ï¼Œç‰ˆæœ¬é“¾çš„å¤´èŠ‚ç‚¹å°±æ˜¯å½“å‰è®°å½•æœ€æ–°ç‰ˆæœ¬çš„å€¼ã€‚<br>
ğŸŒ°<br>
ç°åœ¨å‡è®¾æœ‰ä¸€ä¸ª<code>äº‹åŠ¡ Aï¼ˆid=50ï¼‰</code>ï¼Œæ’å…¥äº†ä¸€æ¡æ•°æ®ï¼Œé‚£ä¹ˆæ­¤æ—¶è¿™æ¡æ•°æ®çš„éšè—å­—æ®µä»¥åŠæŒ‡å‘çš„ <code>undo log</code> å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ’å…¥çš„è¿™æ¡æ•°æ®çš„å€¼æ˜¯ Aï¼Œå› æ­¤æ­¤æ—¶<code>äº‹åŠ¡ A</code> çš„ id æ˜¯ 50ï¼Œæ‰€ä»¥è¿™æ¡æ•°æ®çš„ <code>txr_id</code> å°±æ˜¯ 50ï¼Œ<code>roll_pointer</code> æŒ‡å‘ä¸€ä¸ªç©ºçš„ <code>undo log</code>ï¼Œå› ä¸ºä¹‹å‰è¿™æ¡æ•°æ®æ˜¯æ²¡æœ‰çš„ã€‚<br>
<img src="http://weakcc.github.io/post-images/1636681437542.png" alt="" loading="lazy"><br>
æ¥ç€æœ‰ä¸€ä¸ª<code>äº‹åŠ¡ B</code> è·‘æ¥ä¿®æ”¹äº†ä¸€ä¸‹è¿™æ¡æ•°æ®ï¼ŒæŠŠå€¼æ”¹æˆäº†å€¼ Bï¼Œ<code>äº‹åŠ¡ B</code> çš„ id æ˜¯ 58ï¼Œé‚£ä¹ˆæ­¤æ—¶æ›´æ–°ä¹‹å‰ä¼šç”Ÿæˆä¸€ä¸ª <code>undo log</code> è®°å½•ä¹‹å‰çš„å€¼ï¼Œç„¶åä¼šæŠŠ <code>roll pointer</code> æŒ‡å‘è¿™ä¸ªå®é™…çš„ <code>undo log</code> å›æ»šæ—¥å¿—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br>
<img src="http://weakcc.github.io/post-images/1636681605467.png" alt="" loading="lazy"><br>
æ¥ç€<code>äº‹åŠ¡ C</code> åŒç†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br>
<img src="http://weakcc.github.io/post-images/1636681701729.png" alt="" loading="lazy"><br>
å¤šä¸ªäº‹åŠ¡ä¸²è¡Œæ‰§è¡Œçš„æ—¶å€™ï¼Œæ¯ä¸ªäººä¿®æ”¹äº†ä¸€è¡Œæ•°æ®ï¼Œéƒ½ä¼šæ›´æ–°éšè—å­—æ®µ <code>txr_id</code> å’Œ <code>roll_pointer</code>ï¼ŒåŒæ—¶ä¹‹å‰å¤šä¸ªæ•°æ®å¿«ç…§å¯¹åº”çš„ <code>undo log</code>ï¼Œä¼šé€šè¿‡ <code>roll_pointer</code> æŒ‡é’ˆä¸²è”èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªé‡è¦çš„ç‰ˆæœ¬é“¾ã€‚</p>
<h2 id="readview-å¯è¯»è§†å›¾">ReadView ï¼ˆå¯è¯»è§†å›¾ï¼‰</h2>
<p>ReadView å®é™…ä¸Šæ˜¯å½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰æ´»è·ƒäº‹åŠ¡çš„åˆ—è¡¨ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ç»„æˆéƒ¨åˆ†ï¼š</p>
<ul>
<li><code>m_ids</code>ï¼šåœ¨ç”Ÿæˆ ReadView æ—¶å½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„äº‹åŠ¡ ID åˆ—è¡¨</li>
<li><code>min_trx_id</code>ï¼šåœ¨ç”Ÿæˆ ReadView æ—¶å½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„äº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ IDï¼Œä¹Ÿå°±æ˜¯ m_ids ä¸­çš„æœ€å°å€¼</li>
<li><code>max_trx_id</code>ï¼šåœ¨ç”Ÿæˆ ReadView æ—¶ç³»ç»Ÿä¸­åº”è¯¥åˆ†é…ç»™ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„ ID å€¼</li>
<li><code>creator_trx_id</code>ï¼šç”Ÿæˆ ReadView çš„äº‹åŠ¡å¯¹åº”çš„äº‹åŠ¡ IDï¼Œä¹Ÿå°±æ˜¯å½“å‰äº‹åŠ¡ ID</li>
</ul>
<p>æœ‰äº†è¿™ä¸ª ReadView ä¹‹åï¼Œåœ¨è®¿é—®æŸæ¡è®°å½•æ—¶ï¼Œåªéœ€è¦æŒ‰ç…§ä¸‹è¾¹çš„æ­¥éª¤åˆ¤æ–­è¯¥è®°å½•çš„æŸä¸ªç‰ˆæœ¬æ˜¯å¦å¯è§ï¼š</p>
<ul>
<li>å¦‚æœè¢«è®¿é—®ç‰ˆæœ¬çš„ <code>trx_id</code> å±æ€§å€¼ä¸ ReadView ä¸­çš„ <code>tcreator_trx_id</code> å€¼ç›¸åŒï¼Œæ„å‘³ç€å½“å‰äº‹åŠ¡åœ¨è®¿é—®å®ƒè‡ªå·±ä¿®æ”¹è¿‡çš„è®°å½•ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬è®°å½•å¯ä»¥è¢«å½“å‰äº‹åŠ¡è®¿é—®</li>
<li>å¦‚æœè¢«è®¿é—®ç‰ˆæœ¬çš„ <code>trx_id</code> å±æ€§å€¼å°äº ReadView ä¸­çš„ <code>min_trx_id</code> å€¼ï¼Œè¡¨æ˜ç”Ÿæˆè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡ç”Ÿæˆ ReadView å‰å·²ç»æäº¤ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬è®°å½•å¯ä»¥è¢«å½“å‰äº‹åŠ¡è®¿é—®</li>
<li>å¦‚æœè¢«è®¿é—®ç‰ˆæœ¬çš„ <code>trx_id</code> å±æ€§å€¼å¤§äºæˆ–ç­‰äº ReadView ä¸­çš„ <code>max_trx_id</code> å€¼ï¼Œè¡¨æ˜ç”Ÿæˆè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡ç”Ÿæˆ ReadView åæ‰å¼€å¯ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬è®°å½•ä¸å¯ä»¥è¢«å½“å‰äº‹åŠ¡è®¿é—®</li>
<li>å¦‚æœè¢«è®¿é—®ç‰ˆæœ¬çš„ <code>trx_id</code> å±æ€§å€¼åœ¨ ReadView çš„ <code>min_trx_id</code> å’Œ <code>max_trx_id</code> ä¹‹é—´ï¼Œé‚£å°±éœ€è¦åˆ¤æ–­ä¸€ä¸‹ <code>trx_id</code> å±æ€§å€¼æ˜¯ä¸æ˜¯åœ¨ <code>m_ids</code> åˆ—è¡¨ä¸­ï¼Œå¦‚æœåœ¨ï¼Œè¯´æ˜åˆ›å»º ReadView æ—¶ç”Ÿæˆè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡è¿˜æ˜¯æ´»è·ƒçš„ï¼Œè¯¥ç‰ˆæœ¬ä¸å¯ä»¥è¢«è®¿é—®ï¼›å¦‚æœä¸åœ¨ï¼Œè¯´æ˜åˆ›å»º ReadView æ—¶ç”Ÿæˆè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡å·²ç»è¢«æäº¤ï¼Œè¯¥ç‰ˆæœ¬è®°å½•å¯ä»¥è¢«è®¿é—®</li>
<li>å¦‚æœæŸä¸ªç‰ˆæœ¬çš„è®°å½•å¯¹å½“å‰äº‹åŠ¡ä¸å¯è§çš„è¯ï¼Œé‚£å°±é¡ºç€ç‰ˆæœ¬é“¾æ‰¾åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œç»§ç»­æŒ‰ç…§ä¸Šè¾¹çš„æ­¥éª¤åˆ¤æ–­å¯è§æ€§ï¼Œä¾æ­¤ç±»æ¨ï¼Œç›´åˆ°ç‰ˆæœ¬é“¾ä¸­çš„æœ€åä¸€ä¸ªç‰ˆæœ¬ã€‚å¦‚æœæœ€åä¸€ä¸ªç‰ˆæœ¬ä¹Ÿä¸å¯è§çš„è¯ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€è¯¥æ¡è®°å½•å¯¹è¯¥äº‹åŠ¡å®Œå…¨ä¸å¯è§ï¼ŒæŸ¥è¯¢ç»“æœå°±ä¸åŒ…å«è¯¥è®°å½•</li>
</ul>
<p>ğŸŒ°<br>
å‡è®¾åŸæ¥æ•°æ®åº“é‡Œå°±æœ‰ä¸€è¡Œæ•°æ®ï¼Œå¾ˆæ—©ä»¥å‰å°±æœ‰äº‹åŠ¡æ’å…¥è¿‡äº†ï¼Œäº‹åŠ¡ id æ˜¯ 32ï¼Œä»–çš„åˆå§‹å€¼ï¼Œå¦‚ä¸‹å›¾<br>
<img src="http://weakcc.github.io/post-images/1636682975510.png" alt="" loading="lazy"><br>
æ¥ç€å‘¢ï¼Œæ­¤æ—¶ä¸¤ä¸ªäº‹åŠ¡å¹¶å‘æ¥æ‰§è¡Œäº†ï¼Œä¸€ä¸ª<code>äº‹åŠ¡ A</code>ï¼ˆid=45ï¼‰ï¼Œä¸€ä¸ª<code>äº‹åŠ¡ B</code>ï¼ˆid=59ï¼‰ï¼Œ<code>äº‹åŠ¡ B</code> æ˜¯è¦å»æ›´æ–°è¿™è¡Œæ•°æ®çš„ï¼Œ<code>äº‹åŠ¡ A</code> æ˜¯è¦å»è¯»å–è¿™è¡Œæ•°æ®çš„ï¼Œæ­¤æ—¶ä¸¤ä¸ªäº‹åŠ¡å¦‚ä¸‹<br>
<img src="http://weakcc.github.io/post-images/1636683099964.png" alt="" loading="lazy"><br>
ç°åœ¨<code>äº‹åŠ¡ A</code> ç›´æ¥å¼€å¯ä¸€ä¸ª <code>ReadView</code>ï¼Œè¿™åˆš <code>ReadView</code> é‡Œçš„ <code>m_ids</code> å°±åŒ…å«äº†<code>äº‹åŠ¡ A</code> å’Œ<code>äº‹åŠ¡ B</code> çš„ä¸¤ä¸ª idï¼Œ45 å’Œ 59ï¼Œç„¶å <code>min_trx_id</code> å°±æ˜¯ 45ï¼Œ<code>max_trx_id</code> å°±æ˜¯ 60ï¼Œ<code>creator_trx_id å°±æ˜¯ 45ï¼Œæ˜¯</code>äº‹åŠ¡ A` è‡ªå·±ã€‚</p>
<p>è¿™åˆšæ—¶å€™<code>äº‹åŠ¡ A</code> ç¬¬ä¸€æ¬¡æŸ¥è¯¢è¿™è¡Œæ•°æ®ï¼Œä¼šèµ°ä¸€ä¸ªåˆ¤æ–­ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸‹å½“å‰è¿™è¡Œæ•°æ®çš„ <code>trx_id</code> æ˜¯å¦å°äº <code>ReadView</code> ä¸­çš„ <code>min_trx_id</code>ï¼Œæ­¤æ—¶å‘ç° <code>trx_id=32</code> ï¼Œæ˜¯å°äº <code>ReadView</code> é‡Œçš„ <code>min_trx_id</code> å°±æ˜¯ 45 çš„ï¼Œè¯´æ˜ä½ äº‹åŠ¡å¼€å¯ä¹‹å‰ï¼Œä¿®æ”¹è¿™è¡Œæ•°æ®çš„äº‹åŠ¡æ—©å·²æäº¤ï¼Œæ‰€ä»¥æ­¤æ—¶å¯ä»¥æŸ¥è¯¢è¿™è¡Œæ•°æ®ï¼Œå¦‚ä¸‹<br>
<img src="http://weakcc.github.io/post-images/1636683428146.png" alt="" loading="lazy"><br>
æ¥ç€<code>äº‹åŠ¡ B</code> å¼€å§‹åŠ¨æ‰‹äº†ï¼Œä»–æŠŠè¿™è¡Œæ•°æ®çš„å€¼æ”¹ä¸ºäº†å€¼ Bï¼Œç„¶åè¿™è¡Œæ•°æ®çš„ <code>trx_id</code> è®¾ç½®ä¸ºè‡ªå·±çš„ idï¼Œä¹Ÿå°±æ˜¯ 59ï¼ŒåŒæ—¶ <code>roll_pointer</code> æŒ‡å‘äº†ä¿®æ”¹ä¹‹å‰ç”Ÿæˆçš„ä¸€ä¸ª <code>undo log</code>ï¼Œæ¥ç€è¿™ä¸ª<code>äº‹åŠ¡ B</code> å°±æäº¤äº†ï¼Œå¦‚ä¸‹<br>
<img src="http://weakcc.github.io/post-images/1636683586822.png" alt="" loading="lazy"><br>
è¿™ä¸ªæ—¶å€™ <code>äº‹åŠ¡ A</code> å†æ¬¡æŸ¥è¯¢ï¼Œæ­¤æ—¶æŸ¥è¯¢çš„æ—¶å€™ï¼Œä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æ­¤æ—¶æ•°æ®è¡Œé‡Œçš„ <code>trx_id=59</code>ï¼Œé‚£ä¹ˆè¿™ä¸ª <code>trx_id</code> æ˜¯å¤§äº <code>ReadView</code> é‡Œçš„ <code>min_trx_idï¼ˆ45ï¼‰</code>ï¼ŒåŒæ—¶å°äº <code>ReadView</code> é‡Œçš„ <code>max_trx_idï¼ˆ60ï¼‰</code>ï¼Œè¯´æ˜æ›´æ–°è¿™æ¡æ•°æ®çš„äº‹åŠ¡ï¼Œå¾ˆå¯èƒ½å°±è·Ÿè‡ªå·±å·®ä¸å¤šæ˜¯åŒæ—¶å¼€å¯çš„ï¼Œäºæ˜¯ä¼šçœ‹ä¸€ä¸‹è¿™ä¸ª <code>trx_id=59</code>ï¼Œæ˜¯å¦åœ¨ <code>ReadView</code> çš„ <code>m_ids</code> åˆ—è¡¨é‡Œçš„ï¼Ÿæœç„¶ï¼Œåœ¨ <code>ReadView</code> çš„ <code>m_ids</code> åˆ—è¡¨é‡Œï¼Œæœ‰ 45 å’Œ 59 ä¸¤ä¸ªäº‹åŠ¡ idï¼Œç›´æ¥è¯å®äº†ï¼Œè¿™ä¸ªä¿®æ”¹æ•°æ®çš„äº‹åŠ¡æ˜¯è·Ÿè‡ªå·±åŒä¸€æ—¶æ®µå¹¶å‘æ‰§è¡Œç„¶åæäº¤çš„ï¼Œæ‰€ä»¥è¿™è¡Œæ•°æ®æ˜¯ä¸èƒ½æŸ¥è¯¢çš„ï¼Œå¦‚ä¸‹<br>
<img src="http://weakcc.github.io/post-images/1636683916110.png" alt="" loading="lazy"><br>
æ—¢ç„¶è¿™è¡Œæ•°æ®ä¸èƒ½æŸ¥è¯¢ï¼Œé‚£ä¹ˆæŸ¥è¯¢ä»€ä¹ˆå‘¢ï¼Ÿ<br>
ç®€å•ï¼Œé¡ºç€è¿™æ¡æ•°æ®çš„ <code>roll_pointer</code> é¡ºç€ <code>undo log</code> æ—¥å¿—é“¾æ¡å¾€ä¸‹æ‰¾ï¼Œå°±ä¼šæ‰¾åˆ°æœ€è¿‘ä¸€æ¡ <code>undo log</code>ï¼Œ<code>trx_id</code> æ˜¯ 32ï¼Œæ­¤æ—¶å‘ç° <code>trx_id=32</code>ï¼Œæ˜¯å°äº <code>ReadView</code> é‡Œçš„ <code>min_trx_idï¼ˆ45ï¼‰</code>çš„ï¼Œè¯´æ˜è¿™ä¸ª <code>undo log</code> ç‰ˆæœ¬å¿…ç„¶æ˜¯åœ¨<code>äº‹åŠ¡ A</code> å¼€å¯ä¹‹å‰å°±æ‰§è¡Œä¸”æäº¤çš„ã€‚<br>
å¥½äº†ï¼Œé‚£ä¹ˆå°±æŸ¥è¯¢æœ€è¿‘çš„ <code>undo log</code> é‡Œçš„å€¼å°±å¥½äº†ï¼Œè¿™å°±æ˜¯ <code>undo log</code> å¯¹ç‰ˆæœ¬é“¾æ¡çš„ä½œç”¨ï¼Œä»–å¯ä»¥ä¿å­˜ä¸€ä¸ªå¿«ç…§é“¾æ¡ï¼Œè®©ä½ å¯ä»¥è¯»åˆ°ä¹‹å‰çš„å¿«ç…§å€¼ã€‚å¦‚ä¸‹<br>
<img src="http://weakcc.github.io/post-images/1636684163556.png" alt="" loading="lazy"><br>
å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œçš„æ—¶å€™ï¼Œ<code>äº‹åŠ¡ B</code> æ›´æ–°çš„å€¼ï¼Œé€šè¿‡è¿™å¥— <strong>ReadView + undo log</strong> æ—¥å¿—é“¾æ¡çš„æœºåˆ¶ï¼Œå°±å¯ä»¥ä¿è¯<code>äº‹åŠ¡ A</code> ä¸ä¼šè¯»åˆ°å¹¶å‘æ‰§è¡Œçš„<code>äº‹åŠ¡ B</code> æ›´æ–°çš„å€¼ï¼Œåªä¼šè¯»åˆ°ä¹‹å‰çš„å€¼ã€‚</p>
<p>æ¥ç€å‡è®¾<code>äº‹åŠ¡ A</code> è‡ªå·±æ›´æ–°äº†è¿™è¡Œæ•°æ®ï¼Œæ”¹ä¸ºå€¼ Aï¼Œ<code>trxt_id</code>ä¿®å¥½ä¸º 45ï¼ŒåŒæ—¶ä¿å­˜ä¹‹å‰<code>äº‹åŠ¡ B</code> ä¿®æ”¹å€¼çš„å¿«ç…§ï¼Œå¦‚ä¸‹<br>
<img src="http://weakcc.github.io/post-images/1636684360943.png" alt="" loading="lazy"><br>
æ­¤æ—¶<code>äº‹åŠ¡ A</code> æ¥æŸ¥è¯¢è¿™æ¡æ•°æ®çš„å€¼ï¼Œä¼šå‘ç°è¿™ä¸ª <code>trx_id=45</code>ï¼Œå±…ç„¶è·Ÿè‡ªå·±çš„ <code>ReadView</code>é‡Œçš„ <code>creator_trx_idï¼ˆ45ï¼‰</code>æ˜¯ä¸€æ ·çš„ï¼Œè¯´æ˜ä»€ä¹ˆï¼Ÿ</p>
<p>è¯´æ˜è¿™è¡Œæ•°æ®çš„å°±æ˜¯è‡ªå·±ä¿®æ”¹çš„ï¼Œè‡ªå·±ä¿®æ”¹çš„å€¼å½“ç„¶æ˜¯å¯ä»¥çœ‹åˆ°çš„ï¼Œå¦‚ä¸‹<br>
<img src="http://weakcc.github.io/post-images/1636684489534.png" alt="" loading="lazy"><br>
æ¥ç€åœ¨äº‹åŠ¡Aæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œçªç„¶å¼€å¯ä¸€ä¸ª<code>äº‹åŠ¡ C</code>ï¼Œè¿™ä¸ªäº‹åŠ¡çš„ id æ˜¯ 78ï¼Œç„¶åä»–æ›´æ–°äº†é‚£è¡Œæ•°æ®çš„å€¼ä¸ºå€¼ Cï¼Œè¿˜æäº¤äº†ï¼Œå¦‚ä¸‹<br>
<img src="http://weakcc.github.io/post-images/1636684574035.png" alt="" loading="lazy"><br>
è¿™ä¸ªæ—¶å€™<code>äº‹åŠ¡ A</code> å†å»æŸ¥è¯¢ï¼Œä¼šå‘ç°å½“å‰æ•°æ®çš„ <code>trx_id=78</code>ï¼Œå¤§äºäº†è‡ªå·±çš„ <code>ReadView</code> ä¸­çš„ <code>max_trx_idï¼ˆ60ï¼‰</code>ï¼Œæ­¤æ—¶è¯´æ˜äº†ä»€ä¹ˆï¼Ÿ</p>
<p>è¯´æ˜æ˜¯è¿™ä¸ª <code>äº‹åŠ¡ A</code> å¼€å¯ä¹‹åï¼Œç„¶åæœ‰ä¸€ä¸ªäº‹åŠ¡æ›´æ–°äº†æ•°æ®ï¼Œè‡ªå·±å½“ç„¶æ˜¯ä¸èƒ½çœ‹åˆ°çš„ï¼Œå¦‚ä¸‹<br>
<img src="http://weakcc.github.io/post-images/1636684712358.png" alt="" loading="lazy"><br>
æ­¤æ—¶å°±ä¼šé¡ºç€ <code>undo log</code> å¤šç‰ˆæœ¬é“¾æ¡å¾€ä¸‹æ‰¾ï¼Œå…ˆæ‰¾åˆ°å€¼ A æ˜¯è‡ªå·±ä¹‹å‰ä¿®æ”¹è¿‡çš„ç‰ˆæœ¬ï¼Œå› ä¸ºé‚£ä¸ª <code>trx_id=45</code> è·Ÿè‡ªå·±çš„ <code>ReadVie</code> é‡Œçš„ <code>creator_trx_id</code> æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æ­¤æ—¶ç›´æ¥è¯»å–è‡ªå·±ä¹‹å‰ä¿®æ”¹çš„é‚£ä¸ªç‰ˆæœ¬ï¼Œå¦‚ä¸‹<br>
<img src="http://weakcc.github.io/post-images/1636684860422.png" alt="" loading="lazy"></p>
<blockquote>
<p>æ³¨ï¼šåœ¨ MySQL InnoDB å¼•æ“ä¸­ï¼Œåªæœ‰ READ COMMITTD å’Œ REPEATABLE READ è¿™ä¸¤ç§éš”ç¦»çº§åˆ«æ‰å¯ä»¥ä½¿ç”¨ MVCCï¼Œåº”å¯¹é«˜å¹¶å‘äº‹åŠ¡ï¼ŒMVCC æ¯”å•çº¯çš„åŠ è¡Œé”æ›´æœ‰æ•ˆï¼Œå¼€é”€æ›´å°ã€‚</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[RabbitMQ ä»å…¥é—¨åˆ°æ”¾å¼ƒ]]></title>
        <id>http://weakcc.github.io/post/rabbitmq-cong-ru-men-dao-fang-qi/</id>
        <link href="http://weakcc.github.io/post/rabbitmq-cong-ru-men-dao-fang-qi/">
        </link>
        <updated>2021-11-11T06:24:30.000Z</updated>
        <summary type="html"><![CDATA[<h1 id="æ¦‚å¿µè¯´æ˜">æ¦‚å¿µè¯´æ˜</h1>
<figure data-type="image" tabindex="1"><img src="http://weakcc.github.io/post-images/1636619280369.png" alt="" loading="lazy"></figure>
]]></summary>
        <content type="html"><![CDATA[<h1 id="æ¦‚å¿µè¯´æ˜">æ¦‚å¿µè¯´æ˜</h1>
<figure data-type="image" tabindex="1"><img src="http://weakcc.github.io/post-images/1636619280369.png" alt="" loading="lazy"></figure>
<!-- more -->
<h2 id="broker">Broker</h2>
<p>ç®€å•æ¥è¯´å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å®ä½“ã€‚</p>
<h2 id="exchange">Exchange</h2>
<p>æ¶ˆæ¯äº¤æ¢æœºï¼Œå®ƒæŒ‡å®šæ¶ˆæ¯æŒ‰ä»€ä¹ˆè§„åˆ™ï¼Œè·¯ç”±åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚</p>
<h2 id="queue">Queue</h2>
<p>æ¶ˆæ¯é˜Ÿåˆ—è½½ä½“ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æŠ•å…¥åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ã€‚</p>
<h2 id="binding">Binding</h2>
<p>ç»‘å®šï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æŠŠ <code>exchange</code> å’Œ <code>queue</code> æŒ‰ç…§è·¯ç”±è§„åˆ™ç»‘å®šèµ·æ¥ã€‚</p>
<h2 id="routing-key">Routing Key</h2>
<p>è·¯ç”±å…³é”®å­—ï¼Œ<code>exchange</code> æ ¹æ®è¿™ä¸ªå…³é”®å­—è¿›è¡Œæ¶ˆæ¯æŠ•é€’ã€‚</p>
<h2 id="vhost">vhost</h2>
<p>è™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ª <code>broker</code> é‡Œå¯ä»¥å¼€è®¾å¤šä¸ª <code>vhost</code>ï¼Œç”¨ä½œä¸åŒç”¨æˆ·çš„æƒé™åˆ†ç¦»ã€‚</p>
<h2 id="producer">producer</h2>
<p>æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå°±æ˜¯æŠ•é€’æ¶ˆæ¯çš„ç¨‹åºã€‚</p>
<h2 id="consumer">consumer</h2>
<p>æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå°±æ˜¯æ¥å—æ¶ˆæ¯çš„ç¨‹åºã€‚</p>
<h2 id="channel">channel</h2>
<p>æ¶ˆæ¯é€šé“ï¼Œåœ¨å®¢æˆ·ç«¯çš„æ¯ä¸ªè¿æ¥é‡Œï¼Œå¯å»ºç«‹å¤šä¸ª <code>channel</code>ï¼Œæ¯ä¸ª <code>channel</code> ä»£è¡¨ä¸€ä¸ªä¼šè¯ä»»åŠ¡ã€‚</p>
<h2 id="ä½¿ç”¨è¿‡ç¨‹">ä½¿ç”¨è¿‡ç¨‹</h2>
<ul>
<li>
<ol>
<li>å®¢æˆ·ç«¯è¿æ¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨ï¼Œæ‰“å¼€ä¸€ä¸ªchannel</li>
</ol>
</li>
<li>
<ol start="2">
<li>å®¢æˆ·ç«¯å£°æ˜ä¸€ä¸ª <code>exchange</code>ï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§</li>
</ol>
</li>
<li>
<ol start="3">
<li>å®¢æˆ·ç«¯å£°æ˜ä¸€ä¸ª <code>queue</code>ï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§</li>
</ol>
</li>
<li>
<ol start="4">
<li>å®¢æˆ·ç«¯ä½¿ç”¨ <code>routing key</code>ï¼Œåœ¨ <code>exchange</code> å’Œ <code>queue</code> ä¹‹é—´å»ºç«‹å¥½ç»‘å®šå…³ç³»</li>
</ol>
</li>
<li>
<ol start="5">
<li>å®¢æˆ·ç«¯æŠ•é€’æ¶ˆæ¯åˆ° <code>exchange</code></li>
</ol>
</li>
</ul>
<p><code>exchange</code> æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œå°±æ ¹æ®æ¶ˆæ¯çš„ <code>key</code> å’Œå·²ç»è®¾ç½®çš„ <code>binding</code>ï¼Œè¿›è¡Œæ¶ˆæ¯è·¯ç”±ï¼Œå°†æ¶ˆæ¯æŠ•é€’åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—é‡Œã€‚</p>
<p><code>exchange</code> ä¹Ÿæœ‰å‡ ä¸ªç±»å‹ï¼Œå®Œå…¨æ ¹æ® <code>key</code> è¿›è¡ŒæŠ•é€’çš„å«åš <strong>Direct</strong> äº¤æ¢æœºï¼Œä¾‹å¦‚ï¼Œç»‘å®šæ—¶è®¾ç½®äº† <code>routing key</code>ä¸º â€œabcâ€ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯æäº¤çš„æ¶ˆæ¯ï¼Œåªæœ‰è®¾ç½®äº† <code>key</code> ä¸º â€œabcâ€ çš„æ‰ä¼šæŠ•é€’åˆ°é˜Ÿåˆ—ã€‚å¯¹ <code>key</code> è¿›è¡Œæ¨¡å¼åŒ¹é…åè¿›è¡ŒæŠ•é€’çš„å«åš <strong>Topic</strong> äº¤æ¢æœºï¼Œç¬¦å· <b>#</b> åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯ï¼Œç¬¦å· <b>*</b> åŒ¹é…æ­£å¥½ä¸€ä¸ªè¯ã€‚ä¾‹å¦‚ â€œabc.#â€ åŒ¹é… â€œabc.def.ghiâ€ï¼Œâ€œabc.*â€ åªåŒ¹é… â€œabc.defâ€ã€‚è¿˜æœ‰ä¸€ç§ä¸éœ€è¦ <code>key</code> çš„ï¼Œå«åš <strong>Fanout</strong> äº¤æ¢æœºï¼Œå®ƒé‡‡å–å¹¿æ’­æ¨¡å¼ï¼Œä¸€ä¸ªæ¶ˆæ¯è¿›æ¥æ—¶ï¼ŒæŠ•é€’åˆ°ä¸è¯¥äº¤æ¢æœºç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—ã€‚</p>
<h3 id="direct">Direct</h3>
<figure data-type="image" tabindex="2"><img src="http://weakcc.github.io/post-images/1636619505554.png" alt="" loading="lazy"></figure>
<h3 id="fanout">Fanout</h3>
<figure data-type="image" tabindex="3"><img src="http://weakcc.github.io/post-images/1636619513185.png" alt="" loading="lazy"></figure>
<h3 id="topic">Topic</h3>
<figure data-type="image" tabindex="4"><img src="http://weakcc.github.io/post-images/1636619518110.png" alt="" loading="lazy"></figure>
<p><strong>RabbitMQ</strong> æ”¯æŒæ¶ˆæ¯çš„æŒä¹…åŒ–ï¼Œä¹Ÿå°±æ˜¯æ•°æ®å†™åœ¨ç£ç›˜ä¸Šï¼š</p>
<ul>
<li>
<ol>
<li><code>exchange</code> æŒä¹…åŒ–ï¼Œåœ¨å£°æ˜æ—¶æŒ‡å®š <code>durable =&gt; 1</code></li>
</ol>
</li>
<li>
<ol start="2">
<li><code>queue</code> æŒä¹…åŒ–ï¼Œåœ¨å£°æ˜æ—¶æŒ‡å®š <code>durable =&gt; 1</code></li>
</ol>
</li>
<li>
<ol start="3">
<li>æ¶ˆæ¯æŒä¹…åŒ–ï¼Œåœ¨æŠ•é€’æ—¶æŒ‡å®š <code>delivery_mode =&gt; 2</code>ï¼ˆ1æ˜¯éæŒä¹…åŒ–ï¼‰</li>
</ol>
</li>
</ul>
<blockquote>
<p>å¦‚æœ exchange å’Œ queue éƒ½æ˜¯æŒä¹…åŒ–çš„ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹é—´çš„ binding ä¹Ÿæ˜¯æŒä¹…åŒ–çš„ã€‚å¦‚æœ exchange å’Œ queue ä¸¤è€…ä¹‹é—´æœ‰ä¸€ä¸ªæŒä¹…åŒ–ï¼Œä¸€ä¸ªéæŒä¹…åŒ–ï¼Œå°±ä¸å…è®¸å»ºç«‹ç»‘å®šã€‚</p>
</blockquote>
<h1 id="mac-ä¸‹æ­å»º-php-å¼€å‘ç¯å¢ƒ">Mac ä¸‹æ­å»º PHP å¼€å‘ç¯å¢ƒ</h1>
<h2 id="å®‰è£…-rabbitmq">å®‰è£… RabbitMQ</h2>
<pre><code class="language-php">brew install rabbitmq

brew install rabbitmq-c

pecl install amqp
</code></pre>
<h2 id="php-ä¸­å®ç°æ¶ˆæ¯å‘é€å’Œæ¥æ”¶">PHP ä¸­å®ç°æ¶ˆæ¯å‘é€å’Œæ¥æ”¶</h2>
<p><code>send.php</code></p>
<pre><code class="language-php">&lt;?php

$exchangeName = 'demo';
$routeKey = 'hello';
$message = 'Hello World!';

// å»ºç«‹ TCP è¿æ¥
$connection = new AMQPConnection(
    [
        'host' =&gt; 'localhost',
        'port' =&gt; 5672,
        'vhost' =&gt; '/',
        'login' =&gt; 'guest',
        'password' =&gt; 'guest',
    ]
);
$connection-&gt;connect() or die('Cannot connect to the broker!\n');

try {
    $channel = new AMQPChannel($connection);

    $exchange = new AMQPExchange($channel);
    $exchange-&gt;setName($exchangeName);
    $exchange-&gt;setType(AMQP_EX_TYPE_DIRECT);
    $exchange-&gt;declareExchange();

    echo 'Send Message: ' . $exchange-&gt;publish($message, $routeKey) . &quot;\n&quot;;
    echo &quot;Message Is Sent: &quot; . $message . &quot;\n&quot;;
} catch (AMQPConnectionException $e) {
    var_dump($e-&gt;getMessage());
} catch (Exception $e) {
    var_dump($e-&gt;getMessage());
}

// æ–­å¼€è¿æ¥
$connection-&gt;disconnect();
</code></pre>
<p><code>receive.php</code></p>
<pre><code class="language-php">&lt;?php

$exchangeName = 'demo';
$queueName = 'hello';
$routeKey = 'hello';

// å»ºç«‹TCPè¿æ¥
$connection = new AMQPConnection([
    'host' =&gt; 'localhost',
    'port' =&gt; '5672',
    'vhost' =&gt; '/',
    'login' =&gt; 'guest',
    'password' =&gt; 'guest'
]);
$connection-&gt;connect() or die(&quot;Cannot connect to the broker!\n&quot;);

$channel = new AMQPConnection($connection);
$exchange = new AMQPExchange($channel);
$exchange-&gt;setName($exchangeName);
$exchange-&gt;setType(AMQP_EX_TYPE_DIRECT);
echo 'Exchange Status: ' . $exchange-&gt;declareExchange() . &quot;\n&quot;;

$queue = new AMQPQueue();
$queue-&gt;setName($queueName);

echo 'Message Total: ' . $queue-&gt;declareQueue() . &quot;\n&quot;;

// äº¤æ¢æœºå’Œé˜Ÿåˆ—ç»‘å®š
echo 'Queue Bind: ' . $queue-&gt;bind($exchangeName, $routeKey) . &quot;\n&quot;;

var_dump(&quot;Waiting for message...&quot;);
while(true) {
    $queue-&gt;consume('processMessage');
}

// æ–­å¼€è¿æ¥
$connection-&gt;disconnect();

function processMessage($envelope, $queue)
{
    $msg = $envelope-&gt;getBody();
    var_dump(&quot;Received: &quot; . $msg);
    // æ‰‹åŠ¨å‘é€ACKåº”ç­”
    $queue-&gt;ack($envelope-&gt;getDeliveryTag);
}
</code></pre>
<h1 id="php-php-amqplib-åº“æ“ä½œ-rabbitmq">PHP php-amqplib åº“æ“ä½œ RabbitMQ</h1>
<h2 id="ä½¿ç”¨-composer-è¿›è¡Œ-rabbitmq-ä¾èµ–å®‰è£…">ä½¿ç”¨ composer è¿›è¡Œ rabbitmq ä¾èµ–å®‰è£…</h2>
<pre><code class="language-shell">composer require php-amqplib/php-amqplib
</code></pre>
<h2 id="php-æ“ä½œ-rabbitmq-çš„ç®€å•ç¤ºä¾‹">PHP æ“ä½œ RabbitMQ çš„ç®€å•ç¤ºä¾‹</h2>
<h3 id="ç”Ÿäº§è€…">ç”Ÿäº§è€…</h3>
<pre><code class="language-php">&lt;?php
require '../vendor/autoload.php';

$conf = [
    'host' =&gt; '127.0.0.1',
    'port' =&gt; 5672,
    'user' =&gt; 'guest',
    'pwd'  =&gt; 'guest',
    'vhost' =&gt; '/',
];

$exchangeName = 'kd_sms_send_ex'; // äº¤æ¢æœºå
$queueName = 'kd_sms_send_q'; // é˜Ÿåˆ—åç§°
$routingKey = 'sms_send'; // è·¯ç”±å…³é”®å­—(ä¹Ÿå¯ä»¥çœç•¥) ä¸€èˆ¬éƒ½å¸¦ä¸Šæ–¹ä¾¿äº¤æ¢æœºå¯¹æ¶ˆæ¯è¿›è¡Œä¸åŒé˜Ÿåˆ—çš„æ¨é€ å¦‚æœç»‘å®šçš„æ—¶å€™ä½¿ç”¨äº† $routingKey,é‚£ä¹ˆåœ¨ bashic_publish çš„æ—¶å€™ä¹Ÿè¦æŒ‡å®š $routingKeyï¼Œä¸ç„¶äº¤æ¢æœºæ— æ³•è·¯ç”±åˆ°æŒ‡å®šé˜Ÿåˆ—ï¼Œé»˜è®¤å°±æ¨é€åˆ°ä¸ä½¿ç”¨å…³é”®å­—çš„é˜Ÿåˆ—äº†

// å»ºç«‹ç”Ÿäº§è€…ä¸ mq ä¹‹é—´çš„è¿æ¥
$conn = new \PhpAmqpLib\Connection\AMQPStreamConnection($conf['host'], $conf['port'], $conf['user'], $conf['pwd'], $conf['vhost']);
// åœ¨å·²è¿æ¥åŸºç¡€ä¸Šå»ºç«‹ç”Ÿäº§è€…ä¸ mq ä¹‹é—´çš„é€šé“
$channel = $conn-&gt;channel();
/*
å£°æ˜åˆå§‹åŒ–äº¤æ¢æœº
å‚æ•°è¯´æ˜ï¼š
exchangeï¼šäº¤æ¢æœºåç§°
typeï¼šäº¤æ¢æœºç±»å‹ï¼Œå¸¸è§çš„å¦‚fanoutã€directã€topic =ã€‹directirect ç²¾å‡†æ¨é€ fanout å¹¿æ’­ æ¨é€åˆ°ç»‘å®šåˆ°æ­¤äº¤æ¢æœºä¸‹çš„æ‰€æœ‰é˜Ÿåˆ— topic ç»„æ’­ æ¯”å¦‚ä¸Šé¢æˆ‘ç»‘å®šçš„å…³é”®å­—æ˜¯sms_sendï¼Œé‚£ä¹ˆä»–å¯ä»¥æ¨é€åˆ°*.sms_sendçš„æ‰€æœ‰é˜Ÿåˆ—
passiveï¼šåªæŸ¥è¯¢ä¸åˆ›å»º.å¦‚æœä¸ºtrue,å¦‚æœå­˜åœ¨è¿™ä¸ªé˜Ÿåˆ—,åˆ™ä¼šè¿”å›é˜Ÿåˆ—çš„ä¿¡æ¯.å¦‚æœä¸å­˜åœ¨è¿™ä¸ªé˜Ÿåˆ—..åˆ™ä¼šæŠ›å¼‚å¸¸(ä¸äº¤æ¢æœºä¸åŒçš„æ˜¯,å¦‚æœäº¤æ¢æœºåˆ¤æ–­å­˜åœ¨,åˆ™è¿”å›NULL,å¦åˆ™å¼‚å¸¸)
durableï¼šè®¾ç½®æ˜¯å¦æŒä¹…åŒ–ã€‚durableè®¾ç½®trueè¡¨ç¤ºæŒä¹…åŒ–ï¼Œåä¹‹æ˜¯æŒä¹…åŒ–ã€‚æŒä¹…åŒ–å¯ä»¥å°†å°†æ¢æœºå­˜ç›˜ï¼Œåœ¨æœåŠ¡å™¨é‡å¯æ—¶ä¸ä¼šä¸¢å¤±ç›¸å…³ä¿¡æ¯
autoDeleteï¼šè®¾ç½®æ˜¯å¦è‡ªåŠ¨åˆ é™¤ã€‚autoDeleteè®¾ç½®ä¸ºtrueåˆ™è¡¨ç¤ºè‡ªåŠ¨åˆ é™¤ã€‚è‡ªåŠ¨åˆ é™¤çš„å‰ææ˜¯è‡³å°‘æœ‰ä¸€ä¸ªé˜Ÿåˆ—æˆ–è€…äº¤æ¢æœºä¸è¿™ä¸ªäº¤æ¢å™¨ç»‘å®šçš„é˜Ÿåˆ—æˆ–è€…äº¤æ¢å™¨éƒ½ä¸ä¹‹è§£ç»‘
internalï¼šè®¾ç½®æ˜¯å¦å†…ç½®çš„ã€‚å¦‚æœè®¾ç½®ä¸ºtrueï¼Œåˆ™è¡¨ç¤ºæ˜¯å†…ç½®çš„äº¤æ¢å™¨ï¼Œå®¢æˆ·ç«¯ç¨‹åºæ— æ³•ç›´æ¥å‘é€æ¶ˆæ¯åˆ°è¿™ä¸ªäº¤æ¢å™¨ä¸­ï¼Œåªèƒ½é€šè¿‡äº¤æ¢å™¨è·¯ç”±åˆ°äº¤æ¢å™¨è¿™ç§æ–¹å¼
argumentï¼šå…¶ä»–ä¸€äº›ç»“æ„åŒ–å‚æ•°ï¼Œæ¯”å¦‚alternate-exchange
*/
$channel-&gt;exchange_declare($exchangeName, AMQP_EX_TYPE_DIRECT, false, false, false);
/*
å£°æ˜åˆå§‹åŒ–ä¸€æ¡é˜Ÿåˆ—
å‚æ•°è¯´æ˜ï¼š
queueï¼šé˜Ÿåˆ—çš„åç§°
durableï¼šè®¾ç½®æ˜¯å¦æŒä¹…åŒ–ã€‚ä¸ºtrueåˆ™è®¾ç½®é˜Ÿåˆ—ä¸ºæŒä¹…åŒ–ã€‚æŒä¹…åŒ–çš„é˜Ÿåˆ—ä¼šå­˜ç›˜ï¼Œåœ¨æœåŠ¡å™¨é‡å¯çš„æ—¶å€™å¯ä»¥ä¿è¯ä¸ä¸¢å¤±ç›¸å…³ä¿¡æ¯
exclusiveï¼šè®¾ç½®æ˜¯å¦æ’ä»–ã€‚ä¸ºtrueåˆ™è®¾ç½®å¯¹åˆ—ä¸ºæ’ä»–çš„ã€‚å¦‚æœä¸€ä¸ªé˜Ÿåˆ—è¢«å£°æ˜ä¸ºæ’ä»–é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—ä»…å¯¹é¦–æ¬¡å£°æ˜å®ƒçš„è¿æ¥å¯è§ï¼Œå¹¶åœ¨è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨åˆ é™¤ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸‰ç‚¹ï¼šæ’ä»–é˜Ÿåˆ—æ˜¯åŸºäºè¿æ¥å¯è§ï¼ŒåŒä¸€ä¸ªè¿æ¥çš„ä¸åŒä¿¡é“æ˜¯å¯ä»¥åŒæ—¶è®¿é—®åŒä¸€ä¸ªè¿æ¥åˆ›å»ºçš„æ’ä»–é˜Ÿåˆ—ï¼›â€é¦–æ¬¡â€œæ˜¯æŒ‡å¦‚æœä¸€ä¸ªè¿æ¥å·²ç»å£°æ˜äº†ä¸€ä¸ªæ’ä»–é˜Ÿåˆ—ï¼Œå…¶ä»–è¿æ¥æ˜¯ä¸å…è®¸å»ºç«‹åŒåçš„æ’ä»–é˜Ÿåˆ—çš„ï¼Œè¿™ä¸ªä¸æ™®é€šé˜Ÿåˆ—ä¸åŒï¼›å³ä½¿è¯¥é˜Ÿåˆ—æ˜¯æŒä¹…åä¸œï¼Œä¸€æ—¦è¿æ¥å…³é—­æˆ–è€…å®¢æˆ·ç«¯é€€å‡ºï¼Œè¯¥æ’ä»–é˜Ÿåˆ—éƒ½ä¼šè‡ªåŠ¨è¢«åˆ é™¤ï¼Œè¿™ç§é˜Ÿåˆ—é€‚ç”¨äºä¸€ä¸ªå®¢æˆ·ç«¯åŒäº‹å‘é€å’Œè¯»å–æ¶ˆæ¯çš„åº”ç”¨åœºæ™¯
autoDeleteï¼šè®¾ç½®æ˜¯å¦è‡ªåŠ¨åˆ é™¤ã€‚ä¸ºtrueåˆ™è®¾ç½®é˜Ÿåˆ—ä¸ºè‡ªåŠ¨åˆ é™¤ã€‚è‡ªåŠ¨åˆ é™¤çš„å‰ææ˜¯ï¼šè‡³å°‘æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…è¿æ¥åˆ°è¿™ä¸ªé˜Ÿåˆ—ï¼Œä¹‹åæ‰€æœ‰ä¸è¿™ä¸ªé˜Ÿåˆ—è¿æ¥çš„æ¶ˆè´¹è€…éƒ½æ–­å¼€æ—¶ï¼Œæ‰ä¼šè‡ªåŠ¨åˆ é™¤ã€‚ä¸èƒ½æŠŠè¿™ä¸ªå‚æ•°é”™è¯¯åœ°ç†è§£ä¸ºï¼šâ€å½“è¿æ¥åˆ°æ­¤é˜Ÿåˆ—çš„æ‰€æœ‰å®¢æˆ·ç«¯æ–­å¼€æ—¶ï¼Œè¿™ä¸ªé˜Ÿåˆ—è‡ªåŠ¨åˆ é™¤â€œï¼Œå› ä¸ºç”Ÿäº§è€…å®¢æˆ·ç«¯åˆ›å»ºè¿™ä¸ªé˜Ÿåˆ—ï¼Œæˆ–è€…æ²¡æœ‰æ¶ˆè´¹è€…å®¢æˆ·ç«¯ä¸è¿™ä¸ªé˜Ÿåˆ—è¿æ¥æ—¶ï¼Œéƒ½ä¸ä¼šè‡ªåŠ¨åˆ é™¤è¿™ä¸ªé˜Ÿåˆ—
argumentsï¼šè®¾ç½®é˜Ÿåˆ—çš„å…¶ä»–ä¸€äº›å‚æ•°ï¼Œå¦‚x-message-ttlç­‰
*/
$channel-&gt;queue_declare($queueName, false, true, false, false);
// å°†é˜Ÿåˆ—ä¸æŸä¸ªäº¤æ¢æœºè¿›è¡Œç»‘å®šï¼Œå¹¶ä½¿ç”¨è·¯ç”±å…³é”®å­—
$channel-&gt;queue_bind($queueName, $exchangeName, $routingKey);

//ç”Ÿæˆæ¶ˆæ¯
$msgBody = json_encode([&quot;name&quot; =&gt; &quot;xiaomi&quot;, &quot;age&quot; =&gt; 18]);
// DELIVERY_MODE_PERSISTENT 2 æ¶ˆæ¯æŒä¹…åŒ–
$msg = new \PhpAmqpLib\Message\AMQPMessage($msgBody, ['content_type' =&gt; 'text/plain', 'delivery_mode' =&gt; \PhpAmqpLib\Message\AMQPMessage::DELIVERY_MODE_PERSISTENT]);
// æ¨é€æ¶ˆæ¯åˆ°æŸä¸ªäº¤æ¢æœº
$r = $channel-&gt;basic_publish($msg, $exchangeName, $routingKey);

// å…³é—­é€šé“
$channel-&gt;close();
// å…³é—­è¿æ¥
$conn-&gt;close();
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Laravel é€ŸæŸ¥è¡¨]]></title>
        <id>http://weakcc.github.io/post/laravel-su-cha-biao/</id>
        <link href="http://weakcc.github.io/post/laravel-su-cha-biao/">
        </link>
        <updated>2021-11-11T06:09:21.000Z</updated>
        <content type="html"><![CDATA[<p><a href="https://learnku.com/docs/laravel-cheatsheet/8.x">Laravelé€ŸæŸ¥è¡¨</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[PHP é€ŸæŸ¥è¡¨]]></title>
        <id>http://weakcc.github.io/post/php-su-cha-biao/</id>
        <link href="http://weakcc.github.io/post/php-su-cha-biao/">
        </link>
        <updated>2021-11-10T10:03:53.000Z</updated>
        <summary type="html"><![CDATA[<p><a href="https://www.p2hp.com/phpfuncs.html">PHP é€ŸæŸ¥è¡¨</a></p>
<h1 id="æœ¬åœ°æœåŠ¡å™¨">æœ¬åœ°æœåŠ¡å™¨</h1>
<pre><code class="language-php">php -S localhost:3000
</code></pre>
<h1 id="æ³¨é‡Š">æ³¨é‡Š</h1>
<pre><code class="language-php">// å•è¡Œæ³¨é‡Š

/*
è¿™æ˜¯ä¸€ä¸ªå¤šè¡Œæ³¨é‡Šå—
è·¨è¶Šå¤šè¡Œ
*/
</code></pre>
]]></summary>
        <content type="html"><![CDATA[<p><a href="https://www.p2hp.com/phpfuncs.html">PHP é€ŸæŸ¥è¡¨</a></p>
<h1 id="æœ¬åœ°æœåŠ¡å™¨">æœ¬åœ°æœåŠ¡å™¨</h1>
<pre><code class="language-php">php -S localhost:3000
</code></pre>
<h1 id="æ³¨é‡Š">æ³¨é‡Š</h1>
<pre><code class="language-php">// å•è¡Œæ³¨é‡Š

/*
è¿™æ˜¯ä¸€ä¸ªå¤šè¡Œæ³¨é‡Šå—
è·¨è¶Šå¤šè¡Œ
*/
</code></pre>
<!-- more -->
<h1 id="å‘½åçº¦å®š">å‘½åçº¦å®š</h1>
<h2 id="å¼€å§‹ç»“æŸ-æ ‡è®°">å¼€å§‹/ç»“æŸ æ ‡è®°</h2>
<pre><code class="language-php">&lt;?php
  echo &quot;Hello World&quot;;
?&gt;
</code></pre>
<h2 id="å¦‚æœæ²¡æœ‰ç»“æŸæ ‡è®°æ–‡ä»¶çš„å…¶ä½™éƒ¨åˆ†å°†è¢«è§†ä¸º-php-ä»£ç ">å¦‚æœæ²¡æœ‰ç»“æŸæ ‡è®°ï¼Œæ–‡ä»¶çš„å…¶ä½™éƒ¨åˆ†å°†è¢«è§†ä¸º PHP ä»£ç </h2>
<pre><code class="language-php">&lt;?php
  echo &quot;Hello World&quot;;
</code></pre>
<h2 id="ç®€çŸ­çš„-php-è¯­æ³•è¾“å‡º">ç®€çŸ­çš„ PHP è¯­æ³•è¾“å‡º</h2>
<pre><code class="language-php">&lt;?= &quot;Hello World&quot; ?&gt;
</code></pre>
<h2 id="å¯ç”¨ä¸¥æ ¼æ¨¡å¼-å®ƒå¿…é¡»åœ¨-php-æ–‡ä»¶çš„ç¬¬ä¸€è¡Œ">å¯ç”¨ä¸¥æ ¼æ¨¡å¼ (å®ƒå¿…é¡»åœ¨ PHP æ–‡ä»¶çš„ç¬¬ä¸€è¡Œ)</h2>
<pre><code class="language-php">&lt;? declare(strict_types=1);
</code></pre>
<h2 id="åŒ…æ‹¬ä¸€ä¸ª-php-æ–‡ä»¶">åŒ…æ‹¬ä¸€ä¸ª PHP æ–‡ä»¶</h2>
<pre><code class="language-php">require 'app/Product.php'
</code></pre>
<h2 id="åˆ›å»ºå‘½åç©ºé—´">åˆ›å»ºå‘½åç©ºé—´</h2>
<pre><code class="language-php">namespace App;
</code></pre>
<h2 id="ä½¿ç”¨å‘½åç©ºé—´">ä½¿ç”¨å‘½åç©ºé—´</h2>
<pre><code class="language-php">use App\Product;
</code></pre>
<h2 id="å°é©¼å³°å‘½å">å°é©¼å³°å‘½å</h2>
<pre><code class="language-php">$firstName = 'Mike'

function updateProduct()
</code></pre>
<h2 id="å¤§é©¼å³°å‘½å">å¤§é©¼å³°å‘½å</h2>
<pre><code class="language-php">class ProductItem
</code></pre>
<h2 id="æ‰€æœ‰å¤§å†™å­—æ¯ç”¨ä¸‹åˆ’çº¿åˆ†éš”">æ‰€æœ‰å¤§å†™å­—æ¯ç”¨ä¸‹åˆ’çº¿åˆ†éš”</h2>
<pre><code class="language-php">const ACCESS_KEY = '123abc';
</code></pre>
<h1 id="è¾“å‡º-è¾“å…¥">è¾“å‡º &amp; è¾“å…¥</h1>
<h2 id="è¾“å‡º">è¾“å‡º</h2>
<pre><code class="language-php">echo 'Hello World';
</code></pre>
<h2 id="è°ƒå¼è¾“å‡º">è°ƒå¼è¾“å‡º</h2>
<pre><code class="language-php">var_dump($names);
print_r($products);
</code></pre>
<h2 id="ä»æ§åˆ¶å°è¾“å…¥">ä»æ§åˆ¶å°è¾“å…¥</h2>
<pre><code class="language-php">$name = readline('What is your name : ');
</code></pre>
<h1 id="å˜é‡å£°æ˜">å˜é‡å£°æ˜</h1>
<h2 id="å­—ç¬¦ä¸²">å­—ç¬¦ä¸²</h2>
<pre><code class="language-php">$name = 'Mike';
</code></pre>
<h2 id="å¸ƒå°”å‹">å¸ƒå°”å‹</h2>
<pre><code class="language-php">$isActive = true;
</code></pre>
<h2 id="æ•´å‹">æ•´å‹</h2>
<pre><code class="language-php">$number = 25;
</code></pre>
<h2 id="æµ®ç‚¹å‹">æµ®ç‚¹å‹</h2>
<pre><code class="language-php">$amount = 99.95;
</code></pre>
<h2 id="æ•°ç»„">æ•°ç»„</h2>
<pre><code class="language-php">$fruits = ['orange', 'apple', 'banana'];
</code></pre>
<h2 id="å¸¸é‡">å¸¸é‡</h2>
<pre><code class="language-php">const MAX_USERS = 50;

define('MAX_USERS', 50);
</code></pre>
<h2 id="èµ‹å€¼-å¼•ç”¨-æ˜¯é€šè¿‡-å…³é”®å­—">èµ‹å€¼ 'å¼•ç”¨' æ˜¯é€šè¿‡ &amp; å…³é”®å­—</h2>
<pre><code class="language-php">$name_2 = &amp;$name_1;
</code></pre>
<h2 id="ç±»å‹è½¬æ¢">ç±»å‹è½¬æ¢</h2>
<pre><code class="language-php">$age = (int)readline('Your age: ');

echo 'Your age is' . (string)$age;
</code></pre>
<h2 id="è·å–å˜é‡ç±»å‹">è·å–å˜é‡ç±»å‹</h2>
<pre><code class="language-php">echo gettype($age); // int
</code></pre>
<h2 id="åˆ¤æ–­æ˜¯å¦æ•´å½¢">åˆ¤æ–­æ˜¯å¦æ•´å½¢</h2>
<pre><code class="language-php">echo is_int($age)
</code></pre>
<h2 id="åˆ¤æ–­æ˜¯å¦æµ®ç‚¹å‹">åˆ¤æ–­æ˜¯å¦æµ®ç‚¹å‹</h2>
<pre><code class="language-php">echo is_float($age)
</code></pre>
<h2 id="åˆ¤æ–­æ˜¯å¦å­—ç¬¦ä¸²">åˆ¤æ–­æ˜¯å¦å­—ç¬¦ä¸²</h2>
<pre><code class="language-php">echo is_string($age)
</code></pre>
<h1 id="å­—ç¬¦ä¸²-2">å­—ç¬¦ä¸²</h1>
<h2 id="å•å¼•å·">å•å¼•å·</h2>
<pre><code class="language-php">$name = 'Mike';
</code></pre>
<h2 id="åŒå¼•å·">åŒå¼•å·</h2>
<pre><code class="language-php">$name = &quot;Mike&quot;;
</code></pre>
<h2 id="åŒå¼•å·å­—ç¬¦ä¸²èƒ½å¤Ÿä½¿ç”¨è½¬ä¹‰å­—ç¬¦-n-new-line-t-tab-backslash">åŒå¼•å·å­—ç¬¦ä¸²èƒ½å¤Ÿä½¿ç”¨è½¬ä¹‰å­—ç¬¦ \n = new line  \t = tab  \ = backslash</h2>
<pre><code class="language-php">echo &quot;Hello Mike\nHello David&quot;;
</code></pre>
<h2 id="åŒå¼•å·å­—ç¬¦ä¸²èƒ½å¤Ÿæ’å…¥å˜é‡">åŒå¼•å·å­—ç¬¦ä¸²èƒ½å¤Ÿæ’å…¥å˜é‡</h2>
<pre><code class="language-php">echo &quot;Hello $name&quot;;
</code></pre>
<h2 id="å­—ç¬¦ä¸²æ‹¼æ¥">å­—ç¬¦ä¸²æ‹¼æ¥</h2>
<pre><code class="language-php">echo 'Hello ' . $name;
</code></pre>
<h2 id="å­—ç¬¦ä¸²é•¿åº¦">å­—ç¬¦ä¸²é•¿åº¦</h2>
<pre><code class="language-php">echo strlen($name);
</code></pre>
<h2 id="åˆ é™¤é¦–éƒ¨å’Œå°¾éƒ¨çš„ç©ºæ ¼">åˆ é™¤é¦–éƒ¨å’Œå°¾éƒ¨çš„ç©ºæ ¼</h2>
<pre><code class="language-php">echo trim($text);
</code></pre>
<h2 id="è½¬æ¢ä¸ºå°å†™">è½¬æ¢ä¸ºå°å†™</h2>
<pre><code class="language-php">echo strtolower($email);
</code></pre>
<h2 id="è½¬æ¢ä¸ºå¤§å†™">è½¬æ¢ä¸ºå¤§å†™</h2>
<pre><code class="language-php">echo strtoupper($email);
</code></pre>
<h2 id="å°†é¦–å­—ç¬¦è½¬æ¢ä¸ºå¤§å†™">å°†é¦–å­—ç¬¦è½¬æ¢ä¸ºå¤§å†™</h2>
<pre><code class="language-php">echo ucfirst($name);  // 'Mike' 
</code></pre>
<h2 id="æ›¿æ¢-å°†-text-ä¸­çš„æ–‡æœ¬-a-æ›¿æ¢æˆæ–‡æœ¬-b">æ›¿æ¢ å°† $text ä¸­çš„æ–‡æœ¬ a æ›¿æ¢æˆæ–‡æœ¬ b</h2>
<pre><code class="language-php">echo str_replace('a', 'b', $text);
</code></pre>
<h2 id="å­—ç¬¦ä¸²åŒ…å«-php-8">å­—ç¬¦ä¸²åŒ…å« (PHP 8)</h2>
<pre><code class="language-php">echo str_contains($name, 'ke')  # true
</code></pre>
<h2 id="æŸ¥æ‰¾-k-åœ¨å­—ç¬¦ä¸²ä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®">æŸ¥æ‰¾ &quot;k&quot; åœ¨å­—ç¬¦ä¸²ä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®</h2>
<pre><code class="language-php">$pos = strpos($name, 'k');
</code></pre>
<h2 id="è¿”å›å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†-åç§»é‡-é•¿åº¦">è¿”å›å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ† (åç§»é‡ / é•¿åº¦)</h2>
<pre><code class="language-php">echo substr($name, 0, $pos); # Mi
</code></pre>
<h1 id="æ•°å­—">æ•°å­—</h1>
<h2 id="å¿«æ·å¢åŠ å¹¶èµ‹å€¼">å¿«æ·å¢åŠ å¹¶èµ‹å€¼</h2>
<pre><code class="language-php">$value = 10;
$value++;
// or 
$value += 1;
</code></pre>
<h2 id="å¿«æ·å‡å°‘å¹¶èµ‹å€¼">å¿«æ·å‡å°‘å¹¶èµ‹å€¼</h2>
<pre><code class="language-php">$value = 10;
$value--;
// or 
$value -= 1;
</code></pre>
<h2 id="æ£€æŸ¥æ˜¯å¦æ˜¯æ•°å­—">æ£€æŸ¥æ˜¯å¦æ˜¯æ•°å­—</h2>
<pre><code class="language-php">echo is_numeric('59.99'); # true
</code></pre>
<h2 id="å››èˆäº”å…¥">å››èˆäº”å…¥</h2>
<pre><code class="language-php">echo round(0.80);  // returns 1
</code></pre>
<h2 id="ç²¾ç¡®åœ°å¯¹æ•°å­—è¿›è¡Œå››èˆäº”å…¥">ç²¾ç¡®åœ°å¯¹æ•°å­—è¿›è¡Œå››èˆäº”å…¥</h2>
<pre><code class="language-php">echo round(1.49356, 2));  // returns 1.49
</code></pre>
<h2 id="éšæœºæ•°">éšæœºæ•°</h2>
<pre><code class="language-php">echo(rand(10, 100)); # 89
</code></pre>
<h1 id="æ¡ä»¶è¯­å¥">æ¡ä»¶è¯­å¥</h1>
<h2 id="if-elseif-else">If / elseif / else</h2>
<pre><code class="language-php">if ($condition == 10) {
    echo 'condition 10'
} elseif  ($condition == 5) {
    echo 'condition 5'
} else {
    echo 'all other conditions'
}
</code></pre>
<h2 id="and-ç­‰äº">And ç­‰äº &amp;&amp;</h2>
<pre><code class="language-php">if ($condition === 10 &amp;&amp; $condition2 === 5) {
    echo '10 and 5'
}
</code></pre>
<h2 id="or-ç­‰äº">Or ç­‰äº ||</h2>
<pre><code class="language-php">if ($condition === 10 || $condition2 === 5) {
    echo '10 or 5'
}
</code></pre>
<h2 id="å•è¡Œ">å•è¡Œ</h2>
<pre><code class="language-php">if ($isActive) return true;
</code></pre>
<h2 id="æ£€æŸ¥-null-å€¼">æ£€æŸ¥ null å€¼</h2>
<pre><code class="language-php">if (is_null($name)) {
    
}
</code></pre>
<h2 id="æ¯”è¾ƒæ“ä½œç¬¦">æ¯”è¾ƒæ“ä½œç¬¦</h2>
<pre><code class="language-php">== // æ¾æ•£æ¯”è¾ƒ
=== // ä¸¥æ ¼æ¯”è¾ƒ
!= // ä¸ç­‰äº
|| // æˆ–
&amp;&amp; // ä¸”
&gt; // å¤§äº
&lt; // å°äº
</code></pre>
<h2 id="ä¸‰å…ƒè¿ç®—-true-false">ä¸‰å…ƒè¿ç®— (true : false)</h2>
<pre><code class="language-php">echo $isValid ? 'user valid' : 'user not valid';
</code></pre>
<h2 id="null-åˆå¹¶è¿ç®—">null åˆå¹¶è¿ç®—</h2>
<pre><code class="language-php">echo $name ?? 'Mike';  //output 'Mike' if $name is null
</code></pre>
<h2 id="null-åˆå¹¶èµ‹å€¼">null åˆå¹¶èµ‹å€¼</h2>
<pre><code class="language-php">$name ??= 'Mike';
</code></pre>
<h2 id="null-å®‰å…¨è¿ç®—ç¬¦php-8å¦‚æœæœ‰ä¸€ä¸ªä¸º-nullå°†è¿”å›-null">null å®‰å…¨è¿ç®—ç¬¦ï¼ˆPHP 8ï¼‰å¦‚æœæœ‰ä¸€ä¸ªï¼Ÿä¸º nullï¼Œå°†è¿”å› null</h2>
<pre><code class="language-php">echo $user?-&gt;profile?-&gt;activate();
</code></pre>
<h2 id="null-å®‰å…¨-null-åˆå¹¶-å¦‚æœä¸º-null-å°†è¿”å›-no-user-profile">null å®‰å…¨ + null åˆå¹¶ (å¦‚æœä¸º null å°†è¿”å› ã€No user profileã€)</h2>
<pre><code class="language-php">echo $user?-&gt;profile?-&gt;activate() ?? 'Not applicable';
</code></pre>
<h2 id="é£èˆ¹ç¬¦å·-è¿”å›-1-0-1">é£èˆ¹ç¬¦å· è¿”å› -1 0 1</h2>
<pre><code class="language-php">$names = ['Mike', 'Paul', 'John']
usort($names, function($a, $b) {
    return $a &lt;=&gt; $b;
}
// ['John', 'Mike', 'Paul']
</code></pre>
<h2 id="è½¬æ¢ä¸ºå¸ƒå°”å€¼æ—¶è¿”å›-false">è½¬æ¢ä¸ºå¸ƒå°”å€¼æ—¶è¿”å› false</h2>
<pre><code class="language-php">false, 0, 0.0, null, unset, '0', '', []
</code></pre>
<h2 id="å°†åŒä¸€å˜é‡ä¸å¤šä¸ªå€¼è¿›è¡Œæ¯”è¾ƒ">å°†åŒä¸€å˜é‡ä¸å¤šä¸ªå€¼è¿›è¡Œæ¯”è¾ƒ</h2>
<pre><code class="language-php">switch ($color) {
    case 'red':
        echo 'The color is red';
         break;
    case 'yellow':
        echo 'The color is yellow';
        break;
    case 'red':
        echo 'The color is red';
        break;
    default:
        echo 'The color is unknown';
}
</code></pre>
<h2 id="match-è¡¨è¾¾å¼php-8">Match è¡¨è¾¾å¼ï¼ˆPHP 8ï¼‰</h2>
<pre><code class="language-php">$type = match($color) {
    'red' =&gt; 'danger',
    'yellow', 'orange' =&gt; 'warning',
    'green' =&gt; 'success',
    default =&gt; 'Unknown'
};
</code></pre>
<h2 id="æ£€æŸ¥å˜é‡æ˜¯å¦å£°æ˜">æ£€æŸ¥å˜é‡æ˜¯å¦å£°æ˜</h2>
<pre><code class="language-php">isset($color['red']);  # true
</code></pre>
<h1 id="å¾ªç¯å’Œè¿­ä»£">å¾ªç¯å’Œè¿­ä»£</h1>
<h2 id="for-å¾ªç¯">for å¾ªç¯</h2>
<pre><code class="language-php">for ($i = 0; $i &lt; 20; $i++) {
    echo &quot;i value = &quot; . i;
}
</code></pre>
<h2 id="while-å¾ªç¯">while å¾ªç¯</h2>
<pre><code class="language-php">$number = 1;
while ($number &lt; 10) {
    echo 'value : ' . $number ;
    $number += 1;
}
</code></pre>
<h2 id="do-while">do while</h2>
<pre><code class="language-php">$number = 1;
do {
    echo 'value : ' . $number ;
    $number += 1;
} while ($number &lt; 10);
</code></pre>
<h2 id="foreach-å¸¦æœ‰-break-continue-çš„ç¤ºä¾‹">foreach å¸¦æœ‰ break / continue çš„ç¤ºä¾‹</h2>
<pre><code class="language-php">$values = ['one', 'two', 'three'];
foreach ($values as $value) {
    if ($value === 'two') {
        break; // é€€å‡ºå¾ªç¯
    } elseif ($value === 'three') {
        continue; // ä¸‹ä¸€ä¸ªå¾ªç¯è¿­ä»£
    }
}
</code></pre>
<h1 id="æ•°ç»„-2">æ•°ç»„</h1>
<h2 id="æ•°ç»„å£°æ˜å¯ä»¥åŒ…å«ä»»ä½•ç±»å‹">æ•°ç»„å£°æ˜å¯ä»¥åŒ…å«ä»»ä½•ç±»å‹</h2>
<pre><code class="language-php">$example = ['Mike', 50.2, true, ['10', '20'];
</code></pre>
<h2 id="æ•°ç»„å£°æ˜">æ•°ç»„å£°æ˜</h2>
<pre><code class="language-php">$names = ['Mike', 'Peter', 'Shawn', 'John'];
</code></pre>
<h2 id="ç›´æ¥è®¿é—®ç‰¹å®šå…ƒç´ ">ç›´æ¥è®¿é—®ç‰¹å®šå…ƒç´ </h2>
<pre><code class="language-php">$name[1]
</code></pre>
<h2 id="å¦‚ä½•è®¿é—®æ•°ç»„ä¸­çš„æ•°ç»„å…ƒç´ ">å¦‚ä½•è®¿é—®æ•°ç»„ä¸­çš„æ•°ç»„å…ƒç´ </h2>
<pre><code class="language-php">$example[3][1]
</code></pre>
<h2 id="å°†å…ƒç´ æ·»åŠ åˆ°æ•°ç»„">å°†å…ƒç´ æ·»åŠ åˆ°æ•°ç»„</h2>
<pre><code class="language-php">$names[] = 'Micheal';
</code></pre>
<h2 id="æ•°ç»„åˆå¹¶">æ•°ç»„åˆå¹¶</h2>
<pre><code class="language-php">$array3 = array_merge($array1, $array2);
</code></pre>
<h2 id="ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦æ¥è¿›è¡Œæ•°ç»„åˆå¹¶">ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦æ¥è¿›è¡Œæ•°ç»„åˆå¹¶</h2>
<pre><code class="language-php">$names = ['Mike', 'Peter', 'Paul'];
$people = ['John', ...$names]; // ['John', 'Mike', 'Peter', 'Paul']
</code></pre>
<h2 id="åˆ é™¤æ•°ç»„å…ƒç´ ">åˆ é™¤æ•°ç»„å…ƒç´ </h2>
<pre><code class="language-php">unset($names['Peter']);
</code></pre>
<h2 id="æ•°ç»„è½¬å­—ç¬¦ä¸²">æ•°ç»„è½¬å­—ç¬¦ä¸²</h2>
<pre><code class="language-php">echo implode(', ', $names); // è¾“å‡º Mike, Shawn, John, Micheal
</code></pre>
<h2 id="å­—ç¬¦ä¸²è½¬æ•°ç»„">å­—ç¬¦ä¸²è½¬æ•°ç»„</h2>
<pre><code class="language-php">echo explode(',', $text); // ['Mike', 'Shawn', 'John']
</code></pre>
<h2 id="éå†æ•°ç»„å…ƒç´ ">éå†æ•°ç»„å…ƒç´ </h2>
<pre><code class="language-php">foreach($names as $name) { 
   echo 'Hello ' . $name;
}
</code></pre>
<h2 id="æ•°ç»„ä¸­å…ƒç´ çš„ä¸ªæ•°">æ•°ç»„ä¸­å…ƒç´ çš„ä¸ªæ•°</h2>
<pre><code class="language-php">echo count($names);
</code></pre>
<h2 id="å…³è”æ•°ç»„å£°æ˜-key-value">å…³è”æ•°ç»„å£°æ˜ (key =&gt; value):</h2>
<pre><code class="language-php">$person = ['age' =&gt; 45, 'genre' =&gt; 'men'];
</code></pre>
<h2 id="æ·»åŠ åˆ°æœ«å°¾-æ•°ç»„">æ·»åŠ åˆ°æœ«å°¾. æ•°ç»„:</h2>
<pre><code class="language-php">$person['name'] = 'Mike';
</code></pre>
<h2 id="å¾ªç¯æ•°ç»„-key-value">å¾ªç¯æ•°ç»„ key =&gt; value:</h2>
<pre><code class="language-php">foreach($names as $key =&gt; $value) { 
   echo $key . ' : ' . $value
}
</code></pre>
<h2 id="æ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸä¸ªç‰¹å®šé”®">æ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸä¸ªç‰¹å®šé”®</h2>
<pre><code class="language-php">echo array_key_exists('age', $person);
</code></pre>
<h2 id="è¿”å›é”®">è¿”å›é”®</h2>
<pre><code class="language-php">echo array_keys($person); // ['age', 'genre']
</code></pre>
<h2 id="è¿”å›å€¼">è¿”å›å€¼</h2>
<pre><code class="language-php">echo array_values($person) // [45, 'men']
</code></pre>
<h2 id="æ•°ç»„è¿‡æ»¤å™¨-è¿”å›è¿‡æ»¤åçš„æ•°ç»„">æ•°ç»„è¿‡æ»¤å™¨ (è¿”å›è¿‡æ»¤åçš„æ•°ç»„)</h2>
<pre><code class="language-php">$filteredPeople = array_filter($people, function ($person) {
    return $names-&gt;active;
})
</code></pre>
<h2 id="æ•°ç»„æ˜ å°„-è¿”å›å˜æ¢åçš„æ•°ç»„">æ•°ç»„æ˜ å°„ (è¿”å›å˜æ¢åçš„æ•°ç»„)</h2>
<pre><code class="language-php">$onlyNames = array_map(function($person) {
    return ['name' =&gt; $person-&gt;name];
}, $people)
</code></pre>
<h2 id="æœç´¢å…³è”æ•°ç»„">æœç´¢å…³è”æ•°ç»„</h2>
<pre><code class="language-php">$items = [
        ['id' =&gt; '100', 'name' =&gt; 'product 1'],
        ['id' =&gt; '200', 'name' =&gt; 'product 2'],
        ['id' =&gt; '300', 'name' =&gt; 'product 3'],
        ['id' =&gt; '400', 'name' =&gt; 'product 4'],
    ];
</code></pre>
<h2 id="åœ¨-name-åˆ—ä¸­æœç´¢æ‰€æœ‰å€¼">åœ¨ 'name' åˆ—ä¸­æœç´¢æ‰€æœ‰å€¼</h2>
<pre><code class="language-php">$found_key = array_search('product 3', array_column($items, 'name'));
</code></pre>
<h1 id="å‡½æ•°">å‡½æ•°</h1>
<h2 id="å‡½æ•°å£°æ˜">å‡½æ•°å£°æ˜</h2>
<pre><code class="language-php">function name($firstName, $lastName = 'defaultvalue') {
    return &quot;$firstName $lastName&quot;
}
</code></pre>
<h2 id="å‡½æ•°è°ƒç”¨">å‡½æ•°è°ƒç”¨</h2>
<pre><code class="language-php">name('Mike', 'Taylor');
</code></pre>
<h2 id="å¸¦å‘½åå‚æ•°çš„å‡½æ•°è°ƒç”¨-php-8">å¸¦å‘½åå‚æ•°çš„å‡½æ•°è°ƒç”¨ (PHP 8)</h2>
<pre><code class="language-php">name(firstName: 'Mike', lastName: 'Taylor'); // æ’åºèƒ½å¤Ÿæ”¹å˜
</code></pre>
<h2 id="å‡½æ•°å¯å˜æ•°é‡å‚æ•°">å‡½æ•°å¯å˜æ•°é‡å‚æ•°</h2>
<pre><code class="language-php">function name(...$params) {
    return $params[0] . â€œ â€œ . params[1];
}
</code></pre>
<h2 id="é—­åŒ…å‡½æ•°">é—­åŒ…å‡½æ•°</h2>
<pre><code class="language-php">Route::get('/', function () {
     return view('welcome');
});
</code></pre>
<h2 id="ç®­å¤´å‡½æ•°">ç®­å¤´å‡½æ•°</h2>
<pre><code class="language-php">Route::get('/', fn () =&gt; view('welcome');
</code></pre>
<h2 id="å‚æ•°ç±»å‹å’Œè¿”å›ç±»å‹">å‚æ•°ç±»å‹å’Œè¿”å›ç±»å‹</h2>
<pre><code class="language-php">function display(string $first, string $last) : string {
    return &quot;$first $last&quot;;
}
</code></pre>
<h2 id="ç±»å‹æˆ–ç©ºå€¼">ç±»å‹æˆ–ç©ºå€¼</h2>
<pre><code class="language-php">function display(?string $name) {
   
}
</code></pre>
<h1 id="æ–‡ä»¶">æ–‡ä»¶</h1>
<h2 id="è·å–å½“å‰ç›®å½•">è·å–å½“å‰ç›®å½•</h2>
<pre><code class="language-php">$current_dir = __DIR__;
</code></pre>
<h2 id="æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨">æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</h2>
<pre><code class="language-php">if (file_exists('/posts/first.txt')) {
 
}
</code></pre>
<h2 id="è¯»å–æ–‡ä»¶å†…å®¹åˆ°ä¸€ä¸ªå˜é‡ä¸­">è¯»å–æ–‡ä»¶å†…å®¹åˆ°ä¸€ä¸ªå˜é‡ä¸­</h2>
<pre><code class="language-php">$post = file_get_contents($file);
</code></pre>
<h2 id="æ–‡ä»¶è¯»å–">æ–‡ä»¶è¯»å–</h2>
<pre><code class="language-php">$file = fopen(&quot;test.txt&quot;, &quot;r&quot;);
</code></pre>
<h2 id="è¾“å‡ºè¡Œ-ç›´åˆ°-eof-ç»“æŸ">è¾“å‡ºè¡Œ, ç›´åˆ° EOF ç»“æŸ</h2>
<pre><code class="language-php">while(! feof($file)) {
  $line = fgets($file);
  echo $line. &quot;&lt;br&gt;&quot;;
}
fclose($file);
</code></pre>
<h2 id="æ–‡ä»¶å†™å…¥">æ–‡ä»¶å†™å…¥</h2>
<pre><code class="language-php">$file = fopen('export.csv', 'a');
$array = ['name' =&gt; 'Mike', 'age' =&gt; 45];
</code></pre>
<h2 id="å°†é”®åå†™ä¸º-csv-æ ‡é¢˜">å°†é”®åå†™ä¸º CSV æ ‡é¢˜</h2>
<pre><code class="language-php">fputcsv($file, array_keys($array[0]));
</code></pre>
<h2 id="å†™å…¥è¡Œ-æ ¼å¼ä¸º-csv">å†™å…¥è¡Œ (æ ¼å¼ä¸º csv)</h2>
<pre><code class="language-php">foreach ($array as $row) {
    fputcsv($file, $row); 
}
fclose($file);
</code></pre>
<h1 id="errors">Errors</h1>
<h2 id="æŠ›å‡ºé”™è¯¯">æŠ›å‡ºé”™è¯¯</h2>
<pre><code class="language-php">if (someCondition) {
    throw new Exception('Data format error');
}
</code></pre>
<h2 id="æ•è·é”™è¯¯">æ•è·é”™è¯¯</h2>
<pre><code class="language-php">try {
  $db-&gt;checkData($data);
} catch (Exception $e) {
    echo $e-&gt;getMessage();
}
</code></pre>
<pre><code class="language-php">// å¦‚æœtry catchéƒ½æœ‰returnï¼ŒæŒ‰ç…§æ­£å¸¸æ‰§è¡Œï¼Œç„¶åæ‰§è¡Œfinallyçš„é€»è¾‘ï¼Œå†è¿”å›å¯¹åº”çš„try æˆ–è€…catché‡Œæ‰§è¡Œreturn
// å¦‚æœtry catch finallyéƒ½æœ‰returnï¼Œæ‰§è¡Œå®Œfinallyçš„é€»è¾‘åï¼Œä¼šè°ƒç”¨finallyçš„return
try {
  $db-&gt;checkData($data);
} catch (Exception $e) {
    echo $e-&gt;getMessage();
} finally {

}
</code></pre>
<h1 id="oop">OOP</h1>
<h2 id="ç±»å£°æ˜">ç±»å£°æ˜</h2>
<pre><code class="language-php">class Person 
{
}
</code></pre>
<h2 id="å¯¹è±¡å®ä¾‹">å¯¹è±¡å®ä¾‹</h2>
<pre><code class="language-php">$person = new Person
</code></pre>
<h2 id="ç±»å±æ€§å’Œæ„é€ æ–¹æ³•">ç±»å±æ€§å’Œæ„é€ æ–¹æ³•</h2>
<pre><code class="language-php">class Person 
{
   protected $firstName;
   protected $lastName;
   public function __construct($firstName, $lastName) {
        $this-&gt;firstName = $firstName;
        $this-&gt;lastName = $lastName
   }
}
</code></pre>
<h2 id="æ„é€ å™¨å±æ€§æå‡php-8">æ„é€ å™¨å±æ€§æå‡ï¼ˆPHP 8ï¼‰</h2>
<pre><code class="language-php">class Person 
{
    public function __construct(protected $firstName, protected $lastName) 
    {

    }
}
</code></pre>
<h2 id="è·å–å’Œè®¾ç½®">è·å–å’Œè®¾ç½®</h2>
<pre><code class="language-php">class Person
{
    private $name;

    public function setName($name){
        if(!is_string($name)){
            throw new Exception('$name must be a string!');
        }
        $this-&gt;name = $name;
    }

    public function getName(){
        return $this-&gt;name;
    }
}
</code></pre>
<h2 id="é™æ€æ„é€ æ–¹æ³•">é™æ€æ„é€ æ–¹æ³•</h2>
<pre><code class="language-php">public static function create(...$params) {
    return new self($params)
}
$person = Person::create(â€˜Mikeâ€™, â€˜Taylorâ€™);
</code></pre>
<h2 id="é™æ€æ–¹æ³•">é™æ€æ–¹æ³•</h2>
<pre><code class="language-php">class greeting {
  public static function welcome() {
    echo &quot;Hello World!&quot;;
  }
}
</code></pre>
<h2 id="è°ƒç”¨é™æ€æ–¹æ³•">è°ƒç”¨é™æ€æ–¹æ³•</h2>
<pre><code class="language-php">greeting::welcome();
</code></pre>
<h2 id="é™æ€æ–¹æ³•è°ƒç”¨">é™æ€æ–¹æ³•è°ƒç”¨</h2>
<pre><code class="language-php">class greeting {
  public static function welcome() {
    echo &quot;Hello World!&quot;;
  }

  public function __construct() {
    static::welcome();
  }
}
new greeting();
</code></pre>
<h2 id="é™æ€å¸¸é‡">é™æ€å¸¸é‡</h2>
<pre><code class="language-php">class Connection
{
  const MAX_USER = 100;
}
echo Connection::MAX_USER # 100
</code></pre>
<h2 id="ç±»ç»§æ‰¿">ç±»ç»§æ‰¿</h2>
<pre><code class="language-php">class Customer extends Person
{
    public function name()
    {
        parent::name();
        echo 'Override method';  
    }
}
</code></pre>
<h2 id="self-å…³é”®å­—å¼•ç”¨å½“å‰ç±»ä¸ä¼šåƒé™æ€é‚£æ ·é€šè¿‡ç»§æ‰¿åæœŸç»‘å®šä¿®æ”¹">self å…³é”®å­—å¼•ç”¨å½“å‰ç±»ï¼ˆä¸ä¼šåƒé™æ€é‚£æ ·é€šè¿‡ç»§æ‰¿åæœŸç»‘å®šä¿®æ”¹ï¼‰</h2>
<pre><code class="language-php">self::welcome();
</code></pre>
<h2 id="æ¥å£">æ¥å£</h2>
<pre><code class="language-php">interface Animal {
  public function makeSound();
}

class Cat implements Animal {
  public function makeSound() {
    echo &quot;Meow&quot;;
  }
}
$animal = new Cat();
$animal-&gt;makeSound();
</code></pre>
<h2 id="trait-mix-in">Trait (mix-in)</h2>
<pre><code class="language-php">trait HelloWorld {
    public function sayHello() {
        echo 'Hello World!';
    }
}
class Greetings {
    use HelloWorld;
}
$object = new Greetings();
$object-&gt;sayHello();
</code></pre>
<blockquote>
<p>https://learnku.com/php/t/62217</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Go æ“ä½œMySQL]]></title>
        <id>http://weakcc.github.io/post/go-cao-zuo-mysql/</id>
        <link href="http://weakcc.github.io/post/go-cao-zuo-mysql/">
        </link>
        <updated>2021-11-03T08:44:38.000Z</updated>
        <summary type="html"><![CDATA[<h2 id="ä¸‹è½½ä¾èµ–">ä¸‹è½½ä¾èµ–</h2>
<pre><code class="language-go">go get -u github.com/go-sql-driver/mysql
</code></pre>
]]></summary>
        <content type="html"><![CDATA[<h2 id="ä¸‹è½½ä¾èµ–">ä¸‹è½½ä¾èµ–</h2>
<pre><code class="language-go">go get -u github.com/go-sql-driver/mysql
</code></pre>
<!-- more -->
<h2 id="è¿æ¥">è¿æ¥</h2>
<pre><code class="language-go">package main

import (
	&quot;database/sql&quot;
	&quot;fmt&quot;

	_ &quot;github.com/go-sql-driver/mysql&quot;
)

var db *sql.DB

func initDB() (err error) {
	// ç”¨æˆ·å:å¯†ç @tcp(ip:ç«¯å£)/æ•°æ®åº“å
	dsn := &quot;root:123456@tcp(127.0.0.1:3306)/go_test&quot;
	// Open ä¸ä¼šæ ¡éªŒè´¦å·å¯†ç æ˜¯å¦æ­£ç¡®
	db, err = sql.Open(&quot;mysql&quot;, dsn)
	if err != nil {
		return
	}
	// å°è¯•ä¸æ•°æ®åº“å»ºç«‹è¿æ¥ï¼ˆæ ¡éªŒdsnæ˜¯å¦æ­£ç¡®ï¼‰
	err = db.Ping()
	if err != nil {
		return
    }
	return nil
}

func main()  {
	err:= initDB()
	if err!= nil {
		fmt.Println(err)
		return
	}
	fmt.Println(&quot;è¿æ¥æˆåŠŸï¼&quot;)
}
</code></pre>
<blockquote>
<p>å…¶ä¸­ <code>sql.DB</code> æ˜¯è¡¨ç¤ºè¿æ¥çš„æ•°æ®åº“å¯¹è±¡ï¼ˆç»“æ„ä½“å®ä¾‹ï¼‰ï¼Œå®ƒä¿å­˜äº†è¿æ¥æ•°æ®åº“ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯ã€‚å®ƒå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªå…·æœ‰é›¶åˆ°å¤šä¸ªåº•å±‚è¿æ¥çš„è¿æ¥æ± ï¼Œå®ƒå¯ä»¥å®‰å…¨åœ°è¢«å¤šä¸ª goroutine åŒæ—¶ä½¿ç”¨</p>
</blockquote>
<h2 id="curd">CURD</h2>
<h3 id="æ’å…¥">æ’å…¥</h3>
<pre><code class="language-go">func insertRow()  {
	sqlStr := &quot;insert into user (name, age) values (?, ?)&quot;
	result, err := db.Exec(sqlStr, &quot;å°æ™“&quot;, 11)
	if err != nil {
		fmt.Println(err)
		return
	}
	id, err := result.LastInsertId()
	if err != nil {
		fmt.Println(err)
		return
	}
	fmt.Println(id)
}
</code></pre>
<h3 id="æŸ¥è¯¢">æŸ¥è¯¢</h3>
<h4 id="å•è¡ŒæŸ¥è¯¢">å•è¡ŒæŸ¥è¯¢</h4>
<pre><code class="language-go">func queryRow()  {
	sqlStr := &quot;select id, name, age from user where id = ?&quot;
    var u user
    // ç¡®ä¿ QueryRow ä¹‹åè°ƒç”¨ Scan æ–¹æ³•ï¼Œå¦åˆ™æŒæœ‰çš„æ•°æ®åº“é“¾æ¥ä¸ä¼šè¢«é‡Šæ”¾
	err := db.QueryRow(sqlStr, 1).Scan(&amp;u.id, &amp;u.name, &amp;u.age)
	if err != nil {
		fmt.Println(&quot;é”™è¯¯ï¼š&quot;, err)
		return
	}
	fmt.Println(u)
}
</code></pre>
<h4 id="å¤šè¡ŒæŸ¥è¯¢">å¤šè¡ŒæŸ¥è¯¢</h4>
<pre><code class="language-go">func queryRows()  {
	sqlStr := &quot;select id, name, age from user where id &gt;= ?&quot;
	rows, err := db.Query(sqlStr, 1)
	if err != nil {
		fmt.Println(err)
	}
	// å…³é—­ rows é‡Šæ”¾æŒæœ‰çš„æ•°æ®åº“é“¾æ¥
	defer rows.Close()

	// å¾ªç¯è¯»å–ç»“æœé›†ä¸­çš„æ•°æ®
	for rows.Next() {
		var u user
		err := rows.Scan(&amp;u.id, &amp;u.name, &amp;u.age)
		if err != nil {
			fmt.Println(&quot;é”™è¯¯ï¼š&quot;, err)
			return
		}
		fmt.Println(u)
	}
}
</code></pre>
<h3 id="æ›´æ–°">æ›´æ–°</h3>
<pre><code class="language-go">func updateRow()  {
	sqlStr := &quot;update user set age = ? where id &gt; ?&quot;
	result, err := db.Exec(sqlStr, 12, 2)
	if err != nil {
		fmt.Println(err)
		return
	}
	n, err := result.RowsAffected() // æ“ä½œå—å½±å“çš„è¡Œæ•°
	if err != nil {
		fmt.Println(err)
		return
	}
	fmt.Println(n)
}
</code></pre>
<h3 id="åˆ é™¤æ•°æ®">åˆ é™¤æ•°æ®</h3>
<pre><code class="language-go">func deleteRow()  {
	sqlStr := &quot;delete from user where id = ?&quot;
	result, err := db.Exec(sqlStr, 4)
	if err != nil {
		fmt.Println(err)
		return
	}
	n, err := result.RowsAffected()
	if err != nil {
		fmt.Println(err)
		return
	}
	fmt.Println(n)
}
</code></pre>
<h2 id="é¢„å¤„ç†">é¢„å¤„ç†</h2>
<p>é˜²æ­¢ <code>SQL æ³¨å…¥</code></p>
<h3 id="æŸ¥è¯¢-2">æŸ¥è¯¢</h3>
<pre><code class="language-go">func prepareQuery()  {
	sqlStr := &quot;select id, name, age from user where id &gt;= ?&quot;
	stmt, err := db.Prepare(sqlStr)
	if err != nil {
		fmt.Println(err)
		return
	}
	defer stmt.Close()
	rows, err := stmt.Query(1)
	if err != nil {
		fmt.Println(err)
		return
	}
	defer rows.Close()
	for rows.Next() {
		var u user
		err := rows.Scan(&amp;u.id, &amp;u.name, &amp;u.age)
		if err != nil {
			fmt.Println(err)
			return
		}
		fmt.Println(u)
	}
}
</code></pre>
<h3 id="æ’å…¥æ›´æ–°åˆ é™¤ç±»ä¼¼">æ’å…¥ï¼Œæ›´æ–°ï¼Œåˆ é™¤ç±»ä¼¼</h3>
<pre><code class="language-go">func prepareInsert() {
	sqlStr := &quot;insert into user(name, age) values (?, ?)&quot;
	stmt, err := db.Prepare(sqlStr)
	if err != nil {
		fmt.Println(err)
		return
	}
	defer stmt.Close()
	_, err = stmt.Exec(&quot;å°çˆ±&quot;, 5)
	if err != nil {
		fmt.Println(err)
		return
	}
	fmt.Println(&quot;success&quot;)
}
</code></pre>
<h2 id="äº‹åŠ¡">äº‹åŠ¡</h2>
<pre><code class="language-go">func transactionDemo()  {
	tx, err := db.Begin() // å¼€å¯äº‹åŠ¡
	if err != nil {
		if tx != nil {
			tx.Rollback() // å›æ»š
		}
		fmt.Println(err)
		return
	}
	sqlStr1 := &quot;update user set age = 18 where id = ?&quot;
	result1, err := tx.Exec(sqlStr1, 2)
	if err != nil {
		tx.Rollback()
		fmt.Println(err)
		return
	}
	n1, err := result1.RowsAffected()
	if err != nil {
		tx.Rollback()
		fmt.Println(err)
		return
	}
	sqlStr2 := &quot;update user set age = 18 where id = ?&quot;
	result2, err := tx.Exec(sqlStr2, 1)
	if err != nil {
		tx.Rollback()
		fmt.Println(err)
		return
	}
	n2, err := result2.RowsAffected()
	if err != nil {
		tx.Rollback()
		fmt.Println(err)
		return
	}
	fmt.Println(n1, n2)
	if 1 == n1 &amp;&amp; 1 == n2 {
		tx.Commit() // æäº¤
	} else {
		tx.Rollback()
	}
}
</code></pre>
]]></content>
    </entry>
</feed>